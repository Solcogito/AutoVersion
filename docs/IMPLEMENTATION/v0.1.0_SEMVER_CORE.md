# ⚙️ AutoVersion Lite — v0.1.0 Implementation Plan

---

## 🎯 Objective
Implement full semantic version parsing, validation, and bump logic with CLI commands:
```
autoversion current
autoversion bump [major|minor|patch|prerelease]
```
Supports dry-run mode, proper console output, and unit tests.

---

## 📁 Files to Create / Update

```
src/
├── AutoVersion.Core/
│   ├── VersionModel.cs
│   ├── VersionManager.cs
│   └── VersionExtensions.cs
├── AutoVersion.Cli/
│   ├── Program.cs
│   └── CommandRouter.cs
└── AutoVersion.Tests/
    ├── VersionModelTests.cs
    └── VersionManagerTests.cs
```

---

## 🧱 Core: VersionModel.cs

**Namespace:** `Solcogito.AutoVersion.Core`

```csharp
using System;
using System.Text.RegularExpressions;

namespace Solcogito.AutoVersion.Core
{
    public class VersionModel : IComparable<VersionModel>
    {
        private static readonly Regex SemVerPattern =
            new(@"^(?<major>\d+)\.(?<minor>\d+)\.(?<patch>\d+)(?:-(?<pre>[0-9A-Za-z\.-]+))?(?:\+(?<meta>[0-9A-Za-z\.-]+))?$",
                RegexOptions.Compiled);

        public int Major { get; }
        public int Minor { get; }
        public int Patch { get; }
        public string? PreRelease { get; }
        public string? Metadata { get; }

        public VersionModel(int major, int minor, int patch, string? pre = null, string? meta = null)
        {
            Major = major;
            Minor = minor;
            Patch = patch;
            PreRelease = pre;
            Metadata = meta;
        }

        public static VersionModel Parse(string input)
        {
            if (string.IsNullOrWhiteSpace(input))
                throw new ArgumentException("Version cannot be null or empty.", nameof(input));

            var match = SemVerPattern.Match(input.Trim());
            if (!match.Success)
                throw new FormatException($"Invalid semantic version: {input}");

            return new VersionModel(
                int.Parse(match.Groups["major"].Value),
                int.Parse(match.Groups["minor"].Value),
                int.Parse(match.Groups["patch"].Value),
                match.Groups["pre"].Success ? match.Groups["pre"].Value : null,
                match.Groups["meta"].Success ? match.Groups["meta"].Value : null
            );
        }

        public VersionModel Bump(string part, string? pre = null)
        {
            return part.ToLower() switch
            {
                "major" => new VersionModel(Major + 1, 0, 0, pre),
                "minor" => new VersionModel(Major, Minor + 1, 0, pre),
                "patch" => new VersionModel(Major, Minor, Patch + 1, pre),
                "prerelease" => new VersionModel(Major, Minor, Patch, pre),
                _ => throw new ArgumentException($"Invalid bump type: {part}")
            };
        }

        public int CompareTo(VersionModel? other)
        {
            if (other == null) return 1;
            int result = Major.CompareTo(other.Major);
            if (result != 0) return result;
            result = Minor.CompareTo(other.Minor);
            if (result != 0) return result;
            return Patch.CompareTo(other.Patch);
        }

        public override string ToString()
        {
            var baseVer = $"{Major}.{Minor}.{Patch}";
            if (!string.IsNullOrEmpty(PreRelease))
                baseVer += $"-{PreRelease}";
            if (!string.IsNullOrEmpty(Metadata))
                baseVer += $"+{Metadata}";
            return baseVer;
        }
    }
}
```

---

## 🧩 VersionManager.cs

**Namespace:** `Solcogito.AutoVersion.Core`

Handles reading and writing versions to files (simple local text for now).

```csharp
using System;
using System.IO;

namespace Solcogito.AutoVersion.Core
{
    public static class VersionManager
    {
        private const string DefaultFile = "version.txt";

        public static VersionModel ReadCurrentVersion(string? filePath = null)
        {
            filePath ??= DefaultFile;
            if (!File.Exists(filePath))
                return new VersionModel(0, 0, 0);

            var text = File.ReadAllText(filePath).Trim();
            return VersionModel.Parse(text);
        }

        public static void WriteVersion(VersionModel version, string? filePath = null)
        {
            filePath ??= DefaultFile;
            File.WriteAllText(filePath, version.ToString() + Environment.NewLine);
        }

        public static VersionModel Bump(string type, bool dryRun = false)
        {
            var current = ReadCurrentVersion();
            var next = current.Bump(type);

            Console.WriteLine($"Current: {current} → Next: {next}");
            if (!dryRun)
                WriteVersion(next);

            return next;
        }
    }
}
```

---

## 🧭 CLI Layer

### Program.cs

**Namespace:** `Solcogito.AutoVersion.Cli`

```csharp
using Solcogito.AutoVersion.Cli;

CommandRouter.Run(args);
```

---

### CommandRouter.cs

```csharp
using System;
using System.CommandLine;
using Solcogito.AutoVersion.Core;

namespace Solcogito.AutoVersion.Cli
{
    public static class CommandRouter
    {
        public static void Run(string[] args)
        {
            var root = new RootCommand("AutoVersion Lite CLI — SemVer automation");

            var currentCmd = new Command("current", "Display the current version");
            currentCmd.SetHandler(() =>
            {
                var v = VersionManager.ReadCurrentVersion();
                Console.WriteLine(v.ToString());
            });

            var bumpCmd = new Command("bump", "Increment the version number")
            {
                new Argument<string>("type", "major | minor | patch | prerelease"),
                new Option<bool>("--dry-run", "Simulate bump without modifying files"),
                new Option<string>("--pre", "Optional prerelease tag (e.g., alpha.1)")
            };

            bumpCmd.SetHandler((string type, bool dry, string pre) =>
            {
                try
                {
                    var current = VersionManager.ReadCurrentVersion();
                    var next = current.Bump(type, pre);

                    Console.WriteLine($"Current: {current} → Next: {next}");
                    if (!dry)
                        VersionManager.WriteVersion(next);
                }
                catch (Exception ex)
                {
                    Console.Error.WriteLine($"Error: {ex.Message}");
                }
            },
            bumpCmd.Arguments[0], bumpCmd.Options[0], bumpCmd.Options[1]);

            root.Add(currentCmd);
            root.Add(bumpCmd);

            root.Invoke(args);
        }
    }
}
```

---

## 🧪 Unit Tests

### VersionModelTests.cs

```csharp
using Xunit;
using Solcogito.AutoVersion.Core;

namespace Solcogito.AutoVersion.Tests
{
    public class VersionModelTests
    {
        [Fact]
        public void Parse_ValidVersion_Works()
        {
            var v = VersionModel.Parse("1.2.3-alpha+001");
            Assert.Equal(1, v.Major);
            Assert.Equal(2, v.Minor);
            Assert.Equal(3, v.Patch);
            Assert.Equal("alpha", v.PreRelease);
        }

        [Fact]
        public void Bump_Patch_IncrementsCorrectly()
        {
            var v = new VersionModel(1, 0, 0);
            var next = v.Bump("patch");
            Assert.Equal("1.0.1", next.ToString());
        }

        [Fact]
        public void Compare_WorksCorrectly()
        {
            var v1 = new VersionModel(1, 0, 0);
            var v2 = new VersionModel(1, 0, 1);
            Assert.True(v1.CompareTo(v2) < 0);
        }
    }
}
```

---

### VersionManagerTests.cs

```csharp
using Xunit;
using System.IO;
using Solcogito.AutoVersion.Core;

namespace Solcogito.AutoVersion.Tests
{
    public class VersionManagerTests
    {
        [Fact]
        public void ReadWrite_CreatesAndReadsVersion()
        {
            const string file = "test_version.txt";
            if (File.Exists(file)) File.Delete(file);

            var version = new VersionModel(1, 2, 3);
            VersionManager.WriteVersion(version, file);
            var read = VersionManager.ReadCurrentVersion(file);

            Assert.Equal(version.ToString(), read.ToString());

            File.Delete(file);
        }
    }
}
```

---

## 📘 Documentation Updates

|     File       |                        Change         `          |
|----------------|--------------------------------------------------|
| `README.md`    | Add `v0.1.0` under ROADMAP summary               |
| `CHANGELOG.md` | Add section: “Added SemVer parsing and bump CLI” |
| `ROADMAP.md`   | Mark v0.1.0 complete once tested                 |

---

## 🧪 Testing Checklist

- [ ] Run all unit tests via `pwsh _Infrastructure/build.ps1 -Release`
- [ ] Manually run:
  ```
  dotnet run --project src/AutoVersion.Cli -- current
  dotnet run --project src/AutoVersion.Cli -- bump patch
  ```
- [ ] Verify that `version.txt` increments correctly
- [ ] Test `--dry-run` doesn’t modify the file

---

## ✅ Deliverables

- Functional CLI: `current` and `bump`
- Working SemVer math
- Local version persistence
- Passing unit tests
- Updated docs and changelog
- Commit as:
  ```
  git add .
  git commit -m "feat(core): implement SemVer model and CLI bump command"
  ```

---

**End of v0.1.0 Implementation Plan**
