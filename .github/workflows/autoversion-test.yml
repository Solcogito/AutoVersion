name: üß™ AutoVersion Sandbox Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test-autoversion:
    # Run on both Windows and Ubuntu
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üß∞ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.416'

      - name: üß™ Verify AutoVersion CLI
        shell: pwsh
        run: |
          Write-Host "=== Environment ==="
          Write-Host "Running on $env:RUNNER_OS"
          Write-Host "====================="

          $exe = "./Builds/autoversion.exe"

          if (Test-Path $exe) {
            Write-Host "=== autoversion --version ==="
            & $exe --version
            Write-Host "=== autoversion --help ==="
            & $exe --help
          }
          else {
            Write-Warning "autoversion.exe not found. Skipping CLI tests on $env:RUNNER_OS"
          }

      - name: üß± Run dry-run version bump
        shell: pwsh
        run: |
          $exe = "./Builds/autoversion.exe"
          if (Test-Path $exe) {
            Write-Host "=== Running dry-run version bump ==="
            & $exe bump patch --dry-run --allow-dirty --verbose
          }
          else {
            Write-Warning "Skipping version bump: autoversion.exe missing."
          }

      - name: üßæ Validate CHANGELOG generation
        shell: pwsh
        run: |
          if (Test-Path "CHANGELOG.md") {
            Write-Host "‚úÖ CHANGELOG.md exists"
            Get-Content CHANGELOG.md -TotalCount 10
          }
          else {
            Write-Error "‚ùå Missing CHANGELOG.md"
            exit 1
          }

      - name: üßπ Cleanup build artifacts
        if: always()
        shell: pwsh
        run: |
          Write-Host "Cleaning temporary files..."
          if (Test-Path "Builds") { Remove-Item "Builds/Test*" -Recurse -Force -ErrorAction SilentlyContinue }
