name: Lint â€“ Schema, Docs & Commits

on:
  push:
    branches: [ main, develop ]
  pull_request:

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------
      # 1. Checkout repository
      # ------------------------------------
      - uses: actions/checkout@v4

      # ------------------------------------
      # 2. Setup Node.js for commitlint & linters
      # ------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ------------------------------------
      # 3. Commit message lint (Conventional Commits)
      # ------------------------------------
      - name: Install Commitlint
        run: |
          npm install --save-dev @commitlint/cli @commitlint/config-conventional

      - name: Lint commit messages
        run: npx commitlint --from=HEAD~10 --to=HEAD

      # ------------------------------------
      # 4. JSON validation (autoversion.json)
      # ------------------------------------
      - name: Validate JSON files
        run: |
          npm install --save-dev jsonlint
          npx jsonlint -q autoversion.json

      # ------------------------------------
      # 5. Markdown linting (all docs)
      # ------------------------------------
      - name: Markdown lint
        run: |
          npm install --save-dev markdownlint-cli
          # Use single quotes for shell glob expansion
          npx markdownlint '**/*.md' --ignore node_modules

      # ------------------------------------
      # 6. PowerShell syntax check
      # ------------------------------------
      - name: PowerShell syntax check
        run: |
          pwsh -Command "
            Get-ChildItem -Recurse -Filter *.ps1 | ForEach-Object {
              Write-Host 'Checking:' $_.FullName
              [System.Management.Automation.PSParser]::Tokenize(
                (Get-Content $_ -Raw),
                [ref]$null
              ) | Out-Null
            }
          "
