# ============================================================================
# File:        .github/workflows/ci.yml
# Project:     AutoVersion Lite
# Author:      Benoit Desrosiers (Solcogito S.E.N.C.)
# ----------------------------------------------------------------------------
# Description:
#   Continuous Integration workflow for AutoVersion
#   - Restores dependencies
#   - Builds and tests the solution
#   - Publishes the CLI artifact
#   - Bumps version & updates changelog using AutoVersion CLI
#   - Commits + tags release automatically
# ============================================================================

name: CI / Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      # ---------------------------------------------------------------
      # Checkout
      # ---------------------------------------------------------------
      - name: üßæ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # required for changelog & tags

      # ---------------------------------------------------------------
      # Setup .NET
      # ---------------------------------------------------------------
      - name: üß± Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      # ---------------------------------------------------------------
      # Restore & Build
      # ---------------------------------------------------------------
      - name: üì¶ Restore dependencies
        run: dotnet restore AutoVersion.sln

      - name: üß∞ Build solution
        run: dotnet build AutoVersion.sln --configuration Release --no-restore

      # ---------------------------------------------------------------
      # Run Tests
      # ---------------------------------------------------------------
      - name: üß™ Run unit tests
        run: dotnet test src/AutoVersion.Tests --configuration Release --no-build --logger "trx;LogFileName=test_results.trx"

      # ---------------------------------------------------------------
      # Publish CLI
      # ---------------------------------------------------------------
      - name: üöÄ Publish CLI executable
        run: |
          dotnet publish src/AutoVersion.Cli/AutoVersion.Cli.csproj `
            -c Release `
            -r win-x64 `
            --self-contained true `
            /p:PublishSingleFile=true `
            /p:IncludeAllContentForSelfExtract=true `
            /p:PublishTrimmed=false `
            -o Builds

          if (Test-Path "Builds/AutoVersion.Cli.exe") {
            if (Test-Path "Builds/autoversion.exe") { Remove-Item "Builds/autoversion.exe" -Force }
            Rename-Item "Builds/AutoVersion.Cli.exe" "Builds/autoversion.exe"
          }

      # ---------------------------------------------------------------
      # Run AutoVersion CLI
      # ---------------------------------------------------------------
      - name: üî¢ Bump version & update changelog
        run: |
          .\Builds\autoversion.exe bump patch
        shell: pwsh

      # ---------------------------------------------------------------
      # Commit + Tag (AutoVersion handles tagPrefix = v)
      # ---------------------------------------------------------------
      - name: üè∑Ô∏è Commit and push version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "chore(release): automated version bump"
          git push
          git push --tags

      # ---------------------------------------------------------------
      # Upload build artifacts
      # ---------------------------------------------------------------
      - name: üì¶ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: AutoVersion_Builds
          path: Builds/
